org: peerkatserverless
app: python-serverless-xls20
service: python-serverless-v2

frameworkVersion: '3'

useDotenv: true

provider:
  name: aws
  region: eu-west-2
  iam:
    role: arn:aws:iam::366877760811:role/lambda-role-peerkat-nft-data-serverless
  runtime: python3.9
  layers:
    - arn:aws:lambda:eu-west-2:770693421928:layer:Klayers-p39-pandas:9
  architecture: x86_64

package:
  patterns:
    - '!venv/**'
    - '!data/**'
    - '!node_modules/**'
    - '!.flake8'
    - '!.gitignore'
    - '!Makefile'
    - '!*.json'
    - '!*.csv'
    - '!*.js'
    - '!example.py'
    - '!README.md'
    - '!pyproject.toml'
    - '!requirements-dev.txt'
    - '!env.example'
    - '!env.local'
    - '!logger.log'

functions:
  issuers-nft-dump:
    handler: handlers.issuers_nft_dumps
    name: issuers-nft-dump-${sls:stage}
    timeout: 900
  issuers-taxon-dump:
    handler: handlers.issuers_taxon_dumps
    name: issuers-taxon-dump-${sls:stage}
    timeout: 900
  issuer-nft-pricing:
    handler: handlers.issuer_taxon_average_price_dumps
    name: issuers-nft-pricing-${sls:stage}
    timeout: 900
  issuers-nft-pricing-invoker:
    handler: handlers.issuer_pricing_invoker
    name: issuers-pricing-invoker-${sls:stage}
    timeout: 900
  raw-csv-dump:
    handler: handlers.raw_data_dump
    name: raw-csv-dump-${sls:stage}
    timeout: 900
  nft-table-dump:
    handler: handlers.table_dump
    name: nft-table-dump-${sls:stage}
    timeout: 900
  nft-graph-dump:
    handler: handlers.graph_dump
    name: nft-graph-dump-${sls:stage}
    timeout: 900

stepFunctions:
  stateMachines:
    IssuersNFTDataDump:
      name: IssuersNFTDataDump${sls:stage}
      definition:
        StartAt: NFTDumps
        States:
          NFTDumps:
            Type: Parallel
            Next: NFTPricing
            Branches:
              - StartAt: IssuerNFTDumps
                States:
                  IssuerNFTDumps:
                    Type: Task
                    Resource:
                      Fn::GetAtt: [ issuers-nft-dump, Arn ]
                    End: true
              - StartAt: IssuerTaxonDumps
                States:
                  IssuerTaxonDumps:
                    Type: Task
                    Resource:
                      Fn::GetAtt: [ issuers-taxon-dump, Arn ]
                    End: true
          NFTPricing:
            Type: Task
            Resource:
              Fn::GetAtt: [ issuers-nft-pricing-invoker, Arn ]
            End: true
      events:
        - schedule:
            rate: cron(0/60 * ? * * *)
#    XLS20DataDump:
#      name: XLS20DataDump${sls:stage}
#      definition:
#        StartAt: CSVDump
#        States:
#          CSVDump:
#            Type: Task
#            Next: NFTableDump
#            Resource:
#              Fn::GetAtt: [ raw-csv-dump, Arn ]
#          NFTableDump:
#            Type: Task
#            Resource:
#              Fn::GetAtt: [ nft-table-dump, Arn ]
#            End: true

plugins:
  - serverless-python-requirements
  - serverless-dotenv-plugin
  - serverless-step-functions